'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var _objectSpread = require('@babel/runtime/helpers/objectSpread2');
var links_httpLink_dist_trpcClientLinksHttpLink = require('../../../dist/createTRPCClient-bf4ea9a1.cjs.prod.js');
require('@babel/runtime/helpers/asyncToGenerator');
require('@babel/runtime/helpers/toConsumableArray');
require('@babel/runtime/helpers/classCallCheck');
require('@babel/runtime/helpers/createClass');
require('@babel/runtime/helpers/assertThisInitialized');
require('@babel/runtime/helpers/inherits');
require('@babel/runtime/helpers/createSuper');
require('@babel/runtime/helpers/wrapNativeSuper');
require('@babel/runtime/regenerator');
require('@babel/runtime/helpers/createForOfIteratorHelper');

function httpSubscriptionLink() {
  return function () {
    return function (_ref) {
      var next = _ref.next,
          prev = _ref.prev,
          op = _ref.op,
          onDestroy = _ref.onDestroy;

      if (op.type !== 'subscription') {
        next(op, prev);
        return;
      }

      var input = op.input == null ? {} : op.input;
      var cursor = input.cursor;
      var destroyed = false;
      onDestroy(function () {
        destroyed = true;
      });

      function iterate() {
        if (destroyed) {
          return;
        }

        var nextOp = _objectSpread(_objectSpread({}, op), {}, {
          input: _objectSpread(_objectSpread({}, input), {}, {
            cursor: cursor
          })
        });

        next(nextOp, function (result) {
          var _result$data;

          if (result instanceof Error) {
            var _result$result;

            // timeout - told to reconnect
            ((_result$result = result.result) === null || _result$result === void 0 ? void 0 : _result$result.statusCode) === 408;
            iterate();
            return;
          }

          cursor = (_result$data = result.data) === null || _result$data === void 0 ? void 0 : _result$data.cursor;

          if (!cursor) {
            prev(links_httpLink_dist_trpcClientLinksHttpLink.TRPCClientError.from(new Error('Expected result to return a `cursor` property - needed for HTTP subscriptions')));
            return;
          }

          iterate();
        });
      }

      iterate();
    };
  };
}

exports.httpSubscriptionLink = httpSubscriptionLink;
